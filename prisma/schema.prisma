// This is your Prisma schema file
// Using PostgreSQL for both development and production (via Neon.tech)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional, only needed for migrations on Neon
  // directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// VIEW TRACKING MODELS (Active)
// ============================================

// Page View Tracking
model PageView {
  id        String   @id @default(cuid())
  slug      String
  path      String   // Full path: /blog/article-slug
  ip        String?  // Optional IP tracking (anonymized)
  userAgent String?  // Browser info
  referrer  String?  // Traffic source
  viewedAt  DateTime @default(now())
  
  @@index([slug])
  @@index([viewedAt])
  @@index([path])
}

// Article Statistics (aggregated)
model ArticleStats {
  id            String   @id @default(cuid())
  slug          String   @unique
  viewCount     Int      @default(0)
  uniqueViews   Int      @default(0)
  lastViewedAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([viewCount])
  @@index([slug])
}

// ============================================
// COMMENT SYSTEM (Active)
// ============================================

// User Authentication System
model User {
  id            String     @id @default(cuid())
  email         String     @unique
  username      String     @unique
  password      String     // Hashed password
  name          String?    // Display name
  avatar        String?    // Avatar URL
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  comments      Comment[]
  favorites     Favorite[]
  sessions      Session[]
  
  @@index([email])
  @@index([username])
}

// User Sessions (for NextAuth or custom auth)
model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// Comments for blog articles
model Comment {
  id          String    @id @default(cuid())
  articleSlug String    // Article identifier
  userId      String?   // Optional: Link to registered user
  author      String    // Display name (from user or guest)
  email       String    // Email (for moderation, not displayed)
  content     String    // Comment text
  parentId    String?   // For nested replies
  approved    Boolean   @default(true) // Auto-approved (spam filter via rate limiting)
  ipHash      String?   // Anonymized IP for spam prevention
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Self-referential relation for nested replies
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")
  
  @@index([articleSlug])
  @@index([userId])
  @@index([approved])
  @@index([createdAt])
  @@index([parentId])
}

// User's favorite articles
model Favorite {
  id          String   @id @default(cuid())
  userId      String
  articleSlug String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, articleSlug]) // Prevent duplicate favorites
  @@index([userId])
  @@index([articleSlug])
}

// ============================================
// AFFILIATE MODELS (Commented - uncomment when using PostgreSQL)
// ============================================
// Note: These models use features not supported in SQLite (@db.Text, String[])
// Switch to PostgreSQL to enable these models

/*
// Affiliate Link Management
model AffiliateLink {
  id          String   @id @default(cuid())
  slug        String   @unique
  targetUrl   String
  product     String
  merchant    String
  commission  Float?
  clicks      Int      @default(0)
  conversions Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  clickEvents ClickEvent[]
  
  @@index([slug])
  @@index([merchant])
}

// Track every click for analytics
model ClickEvent {
  id        String   @id @default(cuid())
  linkId    String
  userId    String?
  ipHash    String
  userAgent String
  referrer  String?
  country   String?
  device    String?
  timestamp DateTime @default(now())
  
  link AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  @@index([linkId])
  @@index([timestamp])
}

// Product Catalog
model Product {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String   @db.Text
  image         String?
  price         Float?
  currency      String   @default("USD")
  rating        Float?   @default(0)
  reviewCount   Int      @default(0)
  affiliateLink String
  pros          String[] // Array of pros
  cons          String[] // Array of cons
  category      String
  tags          String[]
  featured      Boolean  @default(false)
  inStock       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  reviews Review[]
  
  @@index([slug])
  @@index([category])
  @@index([featured])
}

// Product Reviews
model Review {
  id        String   @id @default(cuid())
  productId String
  author    String
  rating    Float
  title     String
  content   String   @db.Text
  helpful   Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([rating])
}

// Deal/Coupon Management
model Deal {
  id            String   @id @default(cuid())
  title         String
  description   String   @db.Text
  code          String?
  discount      String
  affiliateLink String
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  clicks        Int      @default(0)
  uses          Int      @default(0)
  createdAt     DateTime @default(now())
  
  @@index([endDate])
  @@index([isActive])
}

// Email Subscribers
model Subscriber {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  subscribed Boolean  @default(true)
  interests  String[] // Categories they're interested in
  source     String?
  createdAt  DateTime @default(now())
  
  @@index([email])
  @@index([subscribed])
}

// Analytics Summary (cached)
model Analytics {
  id          String   @id @default(cuid())
  date        DateTime @unique
  clicks      Int      @default(0)
  conversions Int      @default(0)
  revenue     Float    @default(0)
  visitors    Int      @default(0)
  
  @@index([date])
}
*/
